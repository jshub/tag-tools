/**
 * Simple bridge from the YUI test results (used for the assertions in the test pages)
 * to the test results collector used by rake test.
 *
 * Outputs to the HTML format define by jsunittest.js
 */
 
(function() {
  var SimpleResultsListener = function () {
    var tests = 0, assertions = 0, failures = 0, errors = 0;
    var console = window.console || {
    	log : function (message) { /* discard if no Firebug */ },
      info : function (message) { /* discard if no Firebug */ },
      warn : function (message) { /* discard if no Firebug */ }
    };
    var collectorURL = (function () {
      // example qs generated by autotest ?resultsURL=http://localhost:4711/results&t=1224201232.898165
      var qs = window.location.search;
      var url = qs.match(/.*(\?|&)resultsURL=([^&]+)/);
      return url === null ? null : window.decodeURIComponent(url[2]);
    })();
    
    var logger = null;
    this.initializeLogger = function(element) {
      if (JsUnitTest) {
        logger = new JsUnitTest.Unit.Logger(element); // TODO send a warning if not found
        console.log(logger);
      } else {
        console.warn("Missing jsunittest.js, include that file for html logging");
      }
    }
  
    this.testPassed = function (event) {
      console.log("Test '"+event.testName+"' passed");
      tests++;
      if (logger != null) {
        logger.start(event.testName);
        logger.finish("passed", "Test passed");
      }
    };
    this.testFailed = function (event) {
      console.warn("Test '"+event.testName+"' failed");
      tests++;
      failures++;
      if (logger != null) {
        logger.start(event.testName);
        logger.finish("failed", event.error.message);
      }
    };
    this.testsComplete = function (event) {
      if (logger != null) {
        logger.summary("Tests complete. "+tests+" tests, "+failures+" failed.");
      }      
      if (collectorURL === null) {
        console.log("Test suite complete, no test collector defined");
      } else {
        collectorURL += (collectorURL.indexOf("?") == -1 ? "?" : "&");
        collectorURL += "tests="+tests;
        collectorURL += "&assertions="+tests; // assertions;  but YUItest doesn't let us count these
        collectorURL += "&failures="+failures;
        collectorURL += "&errors="+errors;
        console.info("Test suite complete, reporting to " + collectorURL);
        // TODO: make it a proper form submission
        var img = new Image();
        img.src = collectorURL;
        // console.log(img);
      }
    };
  }
  window.ETL = window.ETL || {};
  ETL.listener = new SimpleResultsListener();
})();